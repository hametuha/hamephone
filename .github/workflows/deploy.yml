name: ğŸš€ Deploy to Cloud Run

on:
  push:
    branches: [ main, master ]

env:
  REGION: asia-northeast1
  SERVICE_NAME: hamephone

jobs:
  test-and-deploy:
    name: Test and Deploy
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run tests
      run: npm test
    
    - name: Google Auth
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
    
    - name: Setup Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
    
    - name: Enable required APIs
      run: |
        gcloud services enable cloudbuild.googleapis.com
        gcloud services enable run.googleapis.com
        gcloud services enable secretmanager.googleapis.com
        gcloud services enable storage.googleapis.com
        gcloud services enable cloudresourcemanager.googleapis.com
    
    - name: Configure Docker
      run: gcloud auth configure-docker
    
    - name: Check Cloud Build permissions
      run: |
        echo "ğŸ” Cloud Buildæ¨©é™ã‚’ç¢ºèªä¸­..."
        gcloud projects get-iam-policy ${{ secrets.GCP_PROJECT_ID }} --flatten="bindings[].members" --filter="bindings.members:github-actions@${{ secrets.GCP_PROJECT_ID }}.iam.gserviceaccount.com" --format="table(bindings.role)" || echo "æ¨©é™ç¢ºèªã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸãŒã€ç¶šè¡Œã—ã¾ã™"
        
        echo "ğŸ” Cloud Buildã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæ¨©é™ã‚’ç¢ºèªä¸­..."
        gcloud projects get-iam-policy ${{ secrets.GCP_PROJECT_ID }} --flatten="bindings[].members" --filter="bindings.members:749371950666@cloudbuild.gserviceaccount.com" --format="table(bindings.role)" || echo "æ¨©é™ç¢ºèªã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸãŒã€ç¶šè¡Œã—ã¾ã™"
    
    - name: Build and push Docker image
      run: |
        echo "ğŸ”§ Cloud Buildã§Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ä¸­..."
        BUILD_ID=$(gcloud builds submit \
          --tag gcr.io/${{ secrets.GCP_PROJECT_ID }}/${{ env.SERVICE_NAME }} \
          --project ${{ secrets.GCP_PROJECT_ID }} \
          --verbosity=debug \
          --timeout=1800 \
          --machine-type=E2_HIGHCPU_8 \
          --format="value(id)" \
          --async)
        
        echo "ğŸ“‹ ãƒ“ãƒ«ãƒ‰ID: $BUILD_ID"
        echo "â³ ãƒ“ãƒ«ãƒ‰ã®å®Œäº†ã‚’å¾…æ©Ÿä¸­..."
        
        # ãƒ“ãƒ«ãƒ‰ã®å®Œäº†ã‚’å¾…æ©Ÿï¼ˆæœ€å¤§30åˆ†ï¼‰
        for i in {1..180}; do
          BUILD_STATUS=$(gcloud builds describe $BUILD_ID --project ${{ secrets.GCP_PROJECT_ID }} --format="value(status)" 2>/dev/null || echo "UNKNOWN")
          echo "ğŸ“Š ãƒ“ãƒ«ãƒ‰çŠ¶æ…‹ ($i/180): $BUILD_STATUS"
          
          if [ "$BUILD_STATUS" = "SUCCESS" ]; then
            echo "âœ… ãƒ“ãƒ«ãƒ‰ãŒæˆåŠŸã—ã¾ã—ãŸ"
            break
          elif [ "$BUILD_STATUS" = "FAILURE" ] || [ "$BUILD_STATUS" = "TIMEOUT" ] || [ "$BUILD_STATUS" = "CANCELLED" ]; then
            echo "âŒ ãƒ“ãƒ«ãƒ‰ãŒå¤±æ•—ã—ã¾ã—ãŸ: $BUILD_STATUS"
            exit 1
          fi
          
          sleep 10
        done
        
        # æœ€çµ‚ç¢ºèª
        FINAL_STATUS=$(gcloud builds describe $BUILD_ID --project ${{ secrets.GCP_PROJECT_ID }} --format="value(status)" 2>/dev/null || echo "UNKNOWN")
        if [ "$FINAL_STATUS" != "SUCCESS" ]; then
          echo "âŒ ãƒ“ãƒ«ãƒ‰ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã¾ãŸã¯å¤±æ•—ã—ã¾ã—ãŸ: $FINAL_STATUS"
          exit 1
        fi
    
    - name: Deploy to Cloud Run
      run: |
        gcloud run deploy ${{ env.SERVICE_NAME }} \
          --image gcr.io/${{ secrets.GCP_PROJECT_ID }}/${{ env.SERVICE_NAME }} \
          --region ${{ env.REGION }} \
          --platform managed \
          --allow-unauthenticated \
          --port 3000 \
          --memory 512Mi \
          --cpu 1 \
          --max-instances 10 \
          --min-instances 0 \
          --set-env-vars PORT=3000 \
          --set-secrets TWILIO_ACCOUNT_SID=twilio-account-sid:latest \
          --set-secrets TWILIO_AUTH_TOKEN=twilio-auth-token:latest \
          --set-secrets TWILIO_PHONE_NUMBER=twilio-phone-number:latest \
          --set-secrets TWILIO_SMS_NUMBER=twilio-sms-number:latest \
          --set-secrets FORWARD_TO=forward-to:latest \
          --set-secrets AWS_ACCESS_KEY_ID=aws-access-key-id:latest \
          --set-secrets AWS_SECRET_ACCESS_KEY=aws-secret-access-key:latest
    
    - name: Show service URL
      run: |
        echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã—ã¾ã—ãŸï¼"
        echo "ğŸŒ ã‚µãƒ¼ãƒ“ã‚¹URL:"
        gcloud run services describe ${{ env.SERVICE_NAME }} --region ${{ env.REGION }} --format="value(status.url)" 